<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Astro Runner ‚Äî Pay to Play</title>
<style>
  :root {
    --bg:#070a12;--fg:#eaf4ff;--brand:#a855f7;
    --muted:#9fb0c3;--panel:#0b1220;
    --ok:#9be28a;--err:#ff7b7b;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:radial-gradient(1200px 600px at 50% -10%,#121a2d 0,#070a12 60%);
    color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    text-align:center;
    overflow:hidden;
  }
  a{color:#66ccff;text-decoration:none}
  .wrap{min-height:100%;display:flex;flex-direction:column}

  /* === Remove white outline === */
  #game { outline:none; }
  #game:focus, #game:focus-visible { outline:none; }
  #game, .fab-btn { -webkit-tap-highlight-color:transparent; }

  /* ===== Dashboard ===== */
  #dashboard{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(1000px 600px at 50% -10%,#121a2d 0,#070a12 70%);
    z-index:50;
  }
  .dash-card{
    background:var(--panel);
    border-radius:20px;
    padding:24px 30px;
    width:min(92vw,420px);
    box-shadow:0 0 28px rgba(168,85,247,0.18);
    text-align:center;
  }
  .dash-title{color:var(--brand);font-size:2rem;margin:0 0 12px}
  .dash-user{color:var(--fg);opacity:.95;margin-bottom:14px}
  .dash-stats{display:flex;justify-content:center;gap:14px;margin:12px 0 18px}
  .dash-stat{
    background:rgba(168,85,247,.08);
    border:1px solid rgba(168,85,247,.35);
    border-radius:12px;
    padding:10px 16px;min-width:92px;
  }
  .dash-stat .v{color:var(--brand);font-weight:800;font-size:1.2rem}
  .dash-stat .k{color:var(--muted);font-size:.8rem}
  .dash-buttons{display:flex;justify-content:center;gap:10px}
  .btn{
    background:var(--brand);
    color:#111;
    border:none;
    border-radius:14px;
    padding:14px 24px;
    font-weight:800;
    cursor:pointer;
  }
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* Intro */
  #intro{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:24px}
  h1{font-size:clamp(2rem,6vw,3rem);margin:0;color:var(--brand)}
  .lead{max-width:560px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  /* HUD */
  #hud{display:none;gap:12px;align-items:center;justify-content:center;padding:10px}
  .chip{
    background:rgba(168,85,247,.08);
    border:1px solid rgba(168,85,247,.35);
    color:var(--brand);
    border-radius:999px;
    padding:8px 12px;
    font-weight:700;
  }

  /* Stage */
  #stage{display:none;width:100vw;margin:0;padding:0}
  .frame{position:relative;border:0;border-radius:0;background:transparent}
  canvas#game{
    display:block;width:100vw;height:calc(100vh - 120px);border-radius:0;
  }

  /* Floating controls */
  #cornerControls{
    position:fixed;right:14px;bottom:14px;
    display:flex;flex-direction:column;gap:12px;
    z-index:40;
  }
  .fab-btn{
    width:68px;height:68px;border-radius:50%;
    border:none;background:#b69cff;color:#fff;
    font-size:28px;font-weight:900;
    box-shadow:0 8px 24px rgba(182,156,255,.35),
                inset 0 0 0 2px rgba(255,255,255,.12);
    cursor:pointer;user-select:none;
  }
  .fab-btn:active{transform:scale(0.98)}
  .fab-btn span{position:relative;top:-1px;}

  dialog{
    border:none;border-radius:16px;background:#0b1220;color:#fff;
    padding:22px;max-width:min(92vw,420px)
  }
  dialog::backdrop{background:rgba(0,0,0,.6)}
</style>
</head>
<body>

<!-- ===== Dashboard ===== -->
<section id="dashboard">
  <div class="dash-card">
    <h2 class="dash-title">üöÄ ASTRO RUNNER</h2>
    <div class="dash-user" id="dashUser">@Player</div>
    <div class="dash-stats">
      <div class="dash-stat"><div class="v" id="dashBest">0</div><div class="k">BEST</div></div>
      <div class="dash-stat"><div class="v" id="dashGames">0</div><div class="k">GAMES</div></div>
      <div class="dash-stat"><div class="v" id="dashLast">0</div><div class="k">LAST</div></div>
    </div>
    <div class="dash-buttons">
      <button class="btn" id="dashStart">Start Game</button>
      <button class="btn" id="dashLeaderboard">Leaderboard</button>
    </div>
  </div>
</section>

<div class="wrap">
  <section id="intro" style="display:none;">
    <h1>üöÄ ASTRO RUNNER</h1>
    <p class="lead">Dodge asteroids in this endless runner. Pay a small Base fee to start. Keyboard: ‚Üê ‚Üë ‚Üì ‚Üí to move, Space to dash. Mobile controls included.</p>
    <div class="row"><button class="btn" id="play">Play</button></div>
    <div id="status"></div>
  </section>

  <div id="hud">
    <div class="chip" id="score">Score: 0</div>
    <div class="chip" id="best">Best: 0</div>
    <button class="btn" id="pause">Pause</button>
    <button class="btn" id="showBoard">Leaderboard</button>
  </div>

  <section id="stage">
    <div class="frame">
      <canvas id="game" width="960" height="540" aria-label="Astro Runner"></canvas>
    </div>
  </section>
</div>

<!-- Floating Up/Down controls -->
<div id="cornerControls">
  <button class="fab-btn" id="upBtn"><span>‚ñ≤</span></button>
  <button class="fab-btn" id="downBtn"><span>‚ñº</span></button>
</div>

<dialog id="over">
  <h3>Game Over</h3>
  <p id="final">Score: 0</p>
  <div class="row" style="margin-top:10px;gap:8px">
    <button class="btn" id="again">Play again</button>
  </div>
</dialog>
<dialog id="board">
  <h3>Leaderboard</h3>
  <ol id="boardList" style="text-align:left"></ol>
  <div class="row" style="margin-top:10px"><button class="btn" id="closeBoard">Close</button></div>
</dialog>

<script>
/********************
 * ASTRO RUNNER GAME
 ********************/
let W=window.innerWidth, H=window.innerHeight;
const rng=(a,b)=>a+Math.random()*(b-a);
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

let cvs,ctx,t=0,dt=0,last=0,raf=0,playing=false,paused=false;
const player={x:W*0.15,y:H*0.5,r:16,vx:0,vy:0,speed:320,dash:0,dashCD:0};
let obstacles=[],stars=[],score=0,best=Number(localStorage.getItem('astroBest')||0);

function initCanvas(){
  cvs=document.getElementById('game');
  ctx=cvs.getContext('2d');
  resizeCanvas();
  // cvs.focus(); ‚Üê removed to stop white line
  stars.length=0;
  for(let i=0;i<160;i++) stars.push({x:Math.random()*W,y:Math.random()*H,z:Math.random()*1.5+0.2});
}

function reset(){
  obstacles.length=0;score=0;
  Object.assign(player,{x:W*0.15,y:H*0.5,vx:0,vy:0,dash:0,dashCD:0});
  over=false;t=0;spawnTimer=0;spawnEvery=1.1;
}
function spawnObstacle(){
  const s=rng(18,40),y=rng(50,H-50);
  obstacles.push({x:W+20,y:y-s,w:s*2,h:s*2,type:'rock',spin:rng(-2,2),a:0});
}
let spawnTimer=0,spawnEvery=1.1;

function update(time){
  dt=(time-last)/1000||0;last=time;
  if(!playing||paused){raf=requestAnimationFrame(update);return draw();}
  t+=dt;spawnTimer+=dt;
  if(spawnTimer>spawnEvery){spawnTimer=0;spawnObstacle();spawnEvery=clamp(spawnEvery-0.01,0.7,2);}
  for(const s of stars){s.x-=(0.6+s.z)*120*dt;if(s.x<-2){s.x=W+Math.random()*50;s.y=Math.random()*H;}}
  const i=inputState();
  const ax=(i.right-i.left)*player.speed*2.5;
  player.vx+=ax*dt;player.vx*=0.92;player.x+=player.vx*dt;player.x=clamp(player.x,18,W*0.65);
  const ay=(i.down-i.up)*player.speed*2.0;
  player.vy+=ay*dt;player.vy*=0.92;player.y+=player.vy*dt;player.y=clamp(player.y,30,H-30);
  player.dashCD=Math.max(0,player.dashCD-dt);
  if(i.dash&&player.dashCD===0){player.dash=0.2;player.dashCD=1.2}
  if(player.dash>0){player.x+=560*dt;player.dash-=dt}
  const sp=260+Math.min(440,t*12);
  for(const o of obstacles){o.x-=sp*dt;if(o.type==='rock'){o.a+=o.spin*dt}}
  obstacles=obstacles.filter(o=>o.x+o.w>-40);
  for(const o of obstacles){if(rectCircleCollide(o,player))return endGame();}
  score+=dt*10;draw();raf=requestAnimationFrame(update);
}
function rectCircleCollide(o,p){
  const nx=clamp(p.x,o.x,o.x+o.w),ny=clamp(p.y,o.y,o.y+o.h);
  const dx=p.x-nx,dy=p.y-ny;return(dx*dx+dy*dy)<p.r*p.r;
}
function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0a1222';ctx.fillRect(0,0,W,H);
  ctx.fillStyle='#182442';for(const s of stars)ctx.fillRect(s.x,s.y,2,2);
  drawShip();for(const o of obstacles){ctx.save();ctx.translate(o.x+o.w/2,o.y+o.h/2);ctx.rotate(o.a);ctx.fillStyle='#c4b5fd';ctx.fillRect(-o.w/2,-o.h/2,o.w,o.h);ctx.restore();}
  document.getElementById('score').textContent='Score: '+Math.floor(score);
}
function drawShip(){
  const p=player;ctx.save();ctx.translate(p.x,p.y);
  const roll=clamp(p.vy/320,-0.35,0.35);ctx.rotate(roll);
  ctx.fillStyle='#9dbcfb';ctx.fillRect(-18,-9,36,18);
  ctx.fillStyle='#c7d2fe';ctx.fillRect(14,-9,10,18);
  ctx.fillStyle='#a78bfa';ctx.fillRect(-10,-13,8,26);
  ctx.restore();
}
const keys=new Set();
function inputState(){return{left:keys.has('ArrowLeft'),right:keys.has('ArrowRight'),up:keys.has('ArrowUp'),down:keys.has('ArrowDown'),dash:keys.has('Space')}}
addEventListener('keydown',e=>{if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code)){keys.add(e.code);e.preventDefault()}})
addEventListener('keyup',e=>keys.delete(e.code))
function wireButtons(){
  const bind=(id,c)=>{const el=document.getElementById(id);if(!el)return;el.onmousedown=()=>keys.add(c);el.onmouseup=()=>keys.delete(c);el.ontouchstart=e=>{e.preventDefault();keys.add(c)};el.ontouchend=e=>{e.preventDefault();keys.delete(c)}};bind('upBtn','ArrowUp');bind('downBtn','ArrowDown');
}
function startLoop(){keys.clear();playing=true;paused=false;document.getElementById('hud').style.display='flex';document.getElementById('stage').style.display='block';cancelAnimationFrame(raf);last=performance.now();raf=requestAnimationFrame(update);}
function pauseToggle(){paused=!paused;document.getElementById('pause').textContent=paused?'Resume':'Pause';if(!paused)last=performance.now()}
function endGame(){playing=false;best=Math.max(best,Math.floor(score));localStorage.setItem('astroBest',best);document.getElementById('best').textContent='Best: '+best;document.getElementById('final').textContent='Score: '+Math.floor(score);document.getElementById('over').showModal();}
initCanvas();wireButtons();
</script>

<script type="module">
import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
sdk.actions.ready();
const RECIPIENT='0x8C6e7978ee3324196ea7e478830fF9cD4AD7D507';
const AMOUNT_ETH='0.00001';
const USE_BASE_SEPOLIA=false;
const BASE_MAINNET={chainId:'0x2105',chainName:'Base',rpcUrls:['https://mainnet.base.org'],nativeCurrency:{name:'Ether',symbol:'ETH',decimals:18},blockExplorerUrls:['https://basescan.org']};
const BASE_SEPOLIA={chainId:'0x14a34',chainName:'Base Sepolia',rpcUrls:['https://sepolia.base.org'],nativeCurrency:{name:'Sepolia Ether',symbol:'ETH',decimals:18},blockExplorerUrls:['https://sepolia.basescan.org']};
const TARGET=USE_BASE_SEPOLIA?BASE_SEPOLIA:BASE_MAINNET;
const statusEl=document.getElementById('status'),playBtn=document.getElementById('play'),againBtn=document.getElementById('again');
let CURRENT_HANDLE='@Player';try{const v=await sdk.viewer.getUser();if(v?.username){CURRENT_HANDLE='@'+v.username;document.getElementById('dashUser').textContent=CURRENT_HANDLE;}}catch{}
function parseEther(x){const[w,f='']=String(x).split('.');const frac=(f+'0'.repeat(18)).slice(0,18);return'0x'+(BigInt(w)*10n**18n+BigInt(frac)).toString(16);}
async function getProvider(){try{const p=await sdk.wallet.getEthereumProvider();if(p)return p;}catch{}return window.ethereum??null;}
async function ensureChain(p,c){const ch=(await p.request({method:'eth_chainId'}))?.toLowerCase();if(ch===c.chainId.toLowerCase())return;try{await p.request({method:'wallet_switchEthereumChain',params:[{chainId:c.chainId}]});}catch(e){if(e?.code===4902){await p.request({method:'wallet_addEthereumChain',params:[c]});await p.request({method:'wallet_switchEthereumChain',params:[{chainId:c.chainId}]});}else throw e;}}
async function requiredPayment(){statusEl.innerHTML='<b>Connecting wallet‚Ä¶</b>';const p=await getProvider();if(!p){statusEl.innerHTML+=' <span class="err">No wallet.</span>';throw new Error('NO_PROVIDER');}const [from]=await p.request({method:'eth_requestAccounts'});await ensureChain(p,TARGET);statusEl.innerHTML+=`<div>Sending ${AMOUNT_ETH} ETH‚Ä¶</div>`;const h=await p.request({method:'eth_sendTransaction',params:[{from,to:RECIPIENT,value:parseEther(AMOUNT_ETH)}]});statusEl.innerHTML+=`<div class="ok">TX sent! <a target="_blank" href="${TARGET.blockExplorerUrls[0]}/tx/${h}">View TX</a></div>`;return h;}
function showGame(){document
